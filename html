<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MKB Chat – Responsive KI-App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* CSS */
    :root {
      --primary-color: #66a6ff;
      --text-primary: #333;
      --text-light: #fff;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 5px 20px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 25px;
      --radius-full: 30px;
      --transition: 0.3s ease;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 10px;
    }
    .wrapper { max-width: 1000px; width: 100%; margin: 0 auto; }
    
    /* Header styles */
    header { text-align: center; margin-bottom: 10px; }
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      color: var(--text-light);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    header p { font-size: 1.1rem; color: rgba(255,255,255,0.9); margin-bottom: 10px; }
    #current-ki {
      margin-top: 8px;
      font-weight: 500;
      color: var(--text-light);
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      display: inline-block;
      backdrop-filter: blur(5px);
    }
    
    /* Button styles */
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }
    button {
      cursor: pointer;
      transition: var(--transition);
      border: none;
      border-radius: var(--radius-full);
      padding: 10px 16px;
      font-weight: 600;
    }
    #btn-ki-slider, #export-chat, .new-conversation {
      background: rgba(255,255,255,0.25);
      color: var(--text-light);
      backdrop-filter: blur(5px);
    }
    
    /* KI-Slider */
    #ki-slider {
      position: fixed;
      top: 0;
      left: -320px;
      width: 320px;
      height: 100%;
      background: rgba(255,255,255,0.95);
      box-shadow: var(--shadow-md);
      transition: transform 0.4s;
      padding: 20px;
      z-index: 1000;
      border-radius: 0 15px 15px 0;
      overflow-y: auto;
    }
    #ki-slider.open { transform: translateX(320px); }
    #ki-slider h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
    }
    #ki-slider button {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 1rem;
      color: var(--text-light);
    }
    
    /* KI button styles */
    .btn-mkr { background: #66BB6A; }
    .btn-mkb { background: #8E24AA; }
    .btn-mkbplus { background: #E53935; }
    .btn-mkplus { background: #FB8C00; }
    .btn-mk { background: #29B6F6; }
    .active-ki {
      box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
      transform: scale(1.02);
    }
    
    /* Chat area */
    .chat-area {
      width: 100%;
      background: rgba(255,255,255,0.9);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin: 10px auto;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
    }
    .chat-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: rgba(255,255,255,0.8);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .chat-message {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      margin-bottom: 14px;
      max-width: 85%;
      word-wrap: break-word;
      box-shadow: var(--shadow-sm);
    }
    .user-message {
      background: #e0f7fa;
      color: #00838f;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .ai-message {
      background: #f1f8e9;
      color: #33691e;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    
    /* Input area */
    .input-area {
      display: flex;
      padding: 12px;
      background: rgba(250,250,250,0.9);
      border-top: 1px solid #ccc;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }
    .input-field {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: var(--radius-full);
      font-size: 1rem;
    }
    .input-area button {
      margin-left: 10px;
      background: var(--primary-color);
      color: var(--text-light);
      font-size: 1rem;
      padding: 12px 16px;
    }
    
    /* Thinking animation */
    .thinking { font-size: 1rem; color: #555; padding: 12px 18px; }
    .ki-think { display: inline-block; margin-left: 5px; }
    .ki-think span {
      display: inline-block;
      width: 8px; height: 8px;
      margin: 0 3px;
      background: var(--primary-color);
      border-radius: 50%;
      opacity: 0.7;
      animation: blink 1.2s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.3); }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      header h1 { font-size: 1.8rem; }
      #ki-slider { width: 80%; max-width: 320px; left: -80%; }
      #ki-slider.open { transform: translateX(100%); }
      .chat-message { max-width: 90%; }
    }
    @media (max-width: 480px) {
      header h1 { font-size: 1.5rem; }
      .chat-area { height: calc(100vh - 140px) !important; }
      .chat-message { max-width: 95%; font-size: 0.95rem; }
      body.slider-open::before {
        content: "";
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.3);
        z-index: 999;
        backdrop-filter: blur(2px);
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- KI-Slider -->
    <div id="ki-slider">
      <h2>KI-Auswahl</h2>
      <button class="btn-mkr" id="btn-mkr"><i class="fa-solid fa-brain"></i> MKR</button>
      <button class="btn-mkb" id="btn-mkb"><i class="fa-solid fa-image"></i> MKB</button>
      <button class="btn-mkbplus" id="btn-mkbplus"><i class="fa-solid fa-images"></i> MKB+</button>
      <button class="btn-mkplus" id="btn-mkplus"><i class="fa-solid fa-comments"></i> MK+</button>
      <button class="btn-mk" id="btn-mk"><i class="fa-solid fa-robot"></i> MK</button>
    </div>
    
    <!-- Header -->
    <header>
      <h1 id="header-title">MKB Chat</h1>
      <p>Klicke auf „KI Auswahl", um ein Modell zu wählen</p>
      <div class="header-buttons">
        <button id="btn-ki-slider"><i class="fa-solid fa-bars"></i> KI Auswahl</button>
        <button class="new-conversation" id="new-conversation"><i class="fa-solid fa-rotate"></i> Neue Konversation</button>
        <button id="export-chat"><i class="fa-solid fa-download"></i> Chat speichern</button>
      </div>
      <div id="current-ki">Aktuelle KI: <span id="kiName">-</span></div>
    </header>
    
    <!-- Chatbereich -->
    <main class="chat-area" id="chat-area">
      <div class="chat-container" id="chat-container"></div>
      <div class="input-area">
        <input type="text" class="input-field" id="user-input" placeholder="Gib deine Nachricht ein..." />
        <button id="send-button"><i class="fa-solid fa-paper-plane"></i> Senden</button>
      </div>
    </main>
  </div>
  
  <!-- JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Grundkonfiguration – der API-Key wird NICHT im Frontend verwendet!
      const displayNames = {MKR: "MKR", MKB: "MKB", "MKB+": "MKB+", "MK+": "MK+", MK: "MK"};
      const themes = {
        "MKR": {primary: "#43A047", background: "linear-gradient(135deg, #E8F5E9, #C8E6C9)"},
        "MKB": {primary: "#8E24AA", background: "linear-gradient(135deg, #F3E5F5, #E1BEE7)"},
        "MKB+": {primary: "#E53935", background: "linear-gradient(135deg, #FFCDD2, #EF9A9A)"},
        "MK+": {primary: "#FB8C00", background: "linear-gradient(135deg, #FFE0B2, #FFCC80)"},
        "MK": {primary: "#0288D1", background: "linear-gradient(135deg, #E1F5FE, #B3E5FC)"}
      };
      const modelMapping = {
        "MKR": "deepseek/deepseek-r1:free",
        "MK": "nvidia/llama-3.1-nemotron-70b-instruct:free",
        "MK+": "deepseek/deepseek-chat:free"
      };
      
      // Statusvariablen
      let conversation = [];
      let currentModel = "MK+";
      
      // DOM-Elemente
      const els = {
        kiSlider: document.getElementById("ki-slider"),
        headerTitle: document.getElementById("header-title"),
        kiName: document.getElementById("kiName"),
        chatContainer: document.getElementById("chat-container"),
        chatArea: document.getElementById("chat-area"),
        btnKISlider: document.getElementById("btn-ki-slider"),
        newConvButton: document.getElementById("new-conversation"),
        userInput: document.getElementById("user-input"),
        sendButton: document.getElementById("send-button"),
        exportButton: document.getElementById("export-chat")
      };
      
      // Funktionen
      const updateChatHeight = () => {
        const headerHeight = document.querySelector("header").offsetHeight;
        const inputHeight = document.querySelector(".input-area").offsetHeight;
        const margin = window.innerWidth <= 480 ? 2 : 10;
        els.chatArea.style.height = (window.innerHeight - headerHeight - inputHeight - margin) + "px";
      };
      
      const updateTheme = model => {
        const theme = themes[model];
        if (!theme) return;
        document.body.style.background = theme.background;
        els.headerTitle.style.color = theme.primary;
        els.btnKISlider.style.backgroundColor = theme.primary;
        document.querySelectorAll(".input-area button").forEach(btn => {
          btn.style.backgroundColor = theme.primary;
        });
      };
      
      const toggleKISlider = () => {
        els.kiSlider.classList.toggle("open");
        document.body.classList.toggle('slider-open');
        els.btnKISlider.innerHTML = els.kiSlider.classList.contains("open")
          ? '<i class="fa-solid fa-xmark"></i> Schließen'
          : '<i class="fa-solid fa-bars"></i> KI Auswahl';
      };
      
      const selectKI = ki => {
        currentModel = ki;
        els.kiName.textContent = displayNames[ki] || ki;
        document.querySelectorAll("#ki-slider button").forEach(btn => btn.classList.remove("active-ki"));
        document.getElementById(`btn-${ki.toLowerCase().replace(/\+/g, "plus")}`).classList.add("active-ki");
        updateTheme(ki);
        toggleKISlider();
      };
      
      const appendMessage = (sender, content) => {
        const msg = document.createElement("div");
        msg.classList.add("chat-message", sender === "user" ? "user-message" : "ai-message");
        msg.innerHTML = marked.parse(content);
        els.chatContainer.appendChild(msg);
        els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
      };
      
      const showThinking = () => {
        const think = document.createElement("div");
        think.id = "thinking-message";
        think.classList.add("chat-message", "ai-message", "thinking");
        think.innerHTML = 'KI denkt <span class="ki-think"><span></span><span></span><span></span></span>';
        els.chatContainer.appendChild(think);
        els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
      };
      
      const removeThinking = () => {
        const think = document.getElementById("thinking-message");
        if (think) think.remove();
      };
      
      // Aufruf an das eigene Backend (API-Proxy)
      const callOpenRouterAPI = async (conv, model) => {
        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model,
              messages: conv.map(m => ({ role: m.role, content: m.content }))
            })
          });
          const data = await res.json();
          return data;
        } catch (err) {
          return { error: err.toString() };
        }
      };
      
      const sendMessage = async () => {
        const text = els.userInput.value.trim();
        if (!text) {
          alert("Bitte gib eine Nachricht ein!");
          return;
        }
        
        appendMessage("user", text);
        conversation.push({ role: "user", content: text });
        els.userInput.value = "";
        if (conversation.length > 6) conversation.shift();
        
        // Hier ggf. weitere Logik zur Modellwahl (wie z. B. bei MKR etc.)
        showThinking();
        const result = await callOpenRouterAPI(conversation, modelMapping[currentModel] || currentModel);
        removeThinking();
        
        if (result.text) {
          appendMessage("ai", `<p>${result.text}</p>`);
          conversation.push({ role: "assistant", content: result.text });
        } else {
          appendMessage("ai", `<p>Fehler: ${result.error}</p>`);
        }
        if (conversation.length > 6) conversation.shift();
      };
      
      const newConversation = () => { 
        els.chatContainer.innerHTML = ""; 
        conversation = []; 
      };
      
      const exportChat = () => {
        const plainText = conversation.map(msg => 
          `${msg.role}: ${msg.content.replace(/<\/?[^>]+(>|$)/g, "")}`
        ).join("\n\n");
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([plainText], { type: "text/plain" }));
        link.download = "chat_verlauf.txt";
        link.click();
      };
      
      // Event listeners
      window.addEventListener("resize", updateChatHeight);
      els.btnKISlider.addEventListener("click", e => {
        e.stopPropagation();
        toggleKISlider();
      });
      els.newConvButton.addEventListener("click", newConversation);
      els.sendButton.addEventListener("click", sendMessage);
      els.userInput.addEventListener("keyup", e => { if (e.key === "Enter") sendMessage(); });
      document.getElementById("btn-mkr").addEventListener("click", () => selectKI("MKR"));
      document.getElementById("btn-mkb").addEventListener("click", () => selectKI("MKB"));
      document.getElementById("btn-mkbplus").addEventListener("click", () => selectKI("MKB+"));
      document.getElementById("btn-mkplus").addEventListener("click", () => selectKI("MK+"));
      document.getElementById("btn-mk").addEventListener("click", () => selectKI("MK"));
      els.exportButton.addEventListener("click", exportChat);
      
      // Klick außerhalb des Sliders schließt diesen
      document.body.addEventListener('click', e => {
        if (document.body.classList.contains('slider-open') && 
            !els.kiSlider.contains(e.target) && 
            e.target !== els.btnKISlider) {
          toggleKISlider();
        }
      });
      
      // Initialisierung
      updateChatHeight();
      newConversation();
      selectKI("MK+");
    });
  </script>
</body>
</html>
